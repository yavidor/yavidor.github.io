<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REDIANCE</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    :root { 
        --accent: #ffb000; 
        --bg: #050505; 
        --border: #333;
        --green: #00ff41; 
        --red: #ff3333; 
    }
    * { box-sizing: border-box; }
    body { 
        background-color: var(--bg); 
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        color: var(--accent); 
        font-family: 'IBM Plex Mono', monospace; 
        margin: 0; 
        height: 100vh; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        overflow: hidden; 
    }
    
    .scanlines { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0) 50%, rgba(0,0,0,0.3) 50%); background-size: 100% 4px; pointer-events: none; z-index: 10; opacity: 0.6; }
    .vignette { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.9) 100%); pointer-events: none; z-index: 11; }

    #terminal-box {
        width: 100%;
        max-width: 800px;
        height: 100%; 
        max-height: 85vh; 
        background: #000;
        border: 1px solid var(--accent);
        display: flex;
        flex-direction: column;
        z-index: 20;
        position: relative;
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
    }
    
    @media (max-width: 600px) {
        #terminal-box { max-height: 95vh; }
    }

    header { 
        border-bottom: 1px solid var(--accent); 
        padding: 12px 20px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        background: #080808;
        font-size: 0.9rem;
        letter-spacing: 2px;
        flex-shrink: 0; 
    }
    .status { font-size: 0.8rem; display: flex; align-items: center; gap: 10px; direction: ltr; }
    .indicator { width: 8px; height: 8px; background: #333; border-radius: 50%; transition:0.3s; }
    .indicator.online { background: var(--green); box-shadow: 0 0 5px var(--green); }
    .indicator.lock { background: var(--red); box-shadow: 0 0 10px var(--red); animation: blink 0.2s infinite; }
    .indicator.ready { background: #555; border:1px solid var(--green); }

    #chat-container { 
        flex: 1; 
        overflow-y: auto; 
        padding: 20px; 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
        background: #000;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) #000;
    }
    
    .msg { display: flex; flex-direction: column; max-width: 75%; }
    .msg.pos-left { align-self: flex-end; align-items: flex-end; direction: ltr; text-align: left; }
    .msg.pos-left .msg-bubble { border-radius: 8px 8px 0 8px; }
    .msg.pos-left .msg-sender { align-self: flex-start; }
    .msg.pos-right { align-self: flex-start; align-items: flex-start; direction: rtl; text-align: right; }
    .msg.pos-right .msg-bubble { border-radius: 8px 8px 8px 0; }
    .msg.pos-right .msg-sender { align-self: flex-start; }

    .msg-sender { font-size: 0.65rem; opacity: 0.8; margin-bottom: 2px; letter-spacing: 1px; font-weight:bold; }
    .msg-bubble { padding: 10px 14px; word-break: break-word; font-size: 0.95rem; line-height: 1.4; border: 1px solid; background: rgba(255,255,255,0.03); }
    
    #input-area { 
        border-top: 1px solid var(--accent); 
        padding: 0; 
        display: flex; 
        background: #080808;
        height: 50px;
        flex-shrink: 0; 
    }
    input { 
        flex: 1; 
        background: transparent; 
        border: none; 
        color: var(--accent); 
        padding: 0 20px; 
        font-family: inherit; 
        font-size: 1rem; 
        outline: none;
        direction: rtl; 
    }
    input:disabled { opacity: 0.3; cursor: not-allowed; }
    
    button#btn-main { 
        background: var(--accent); 
        border: none; 
        border-right: 1px solid #000;
        color: #000; 
        font-weight: bold; 
        padding: 0 30px; 
        cursor: pointer; 
        font-family: inherit; 
        font-size: 0.9rem;
        transition: 0.2s; 
    }
    button#btn-main:hover { background: #ffcc33; }
    button#btn-main:disabled { background: #333; color: #555; cursor: not-allowed; }

    .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index: 50; display:none; justify-content:center; align-items:center; flex-direction:column; }
    .modal-box { border: 1px solid var(--accent); padding: 40px; background: #050505; text-align: center; width: 320px; box-shadow: 0 0 20px rgba(255,176,0,0.1); }
    .modal-box h2 { margin-top:0; font-size:1.2rem; letter-spacing:2px; margin-bottom:20px; direction:ltr; }
    .modal-box.lockdown { border-color: var(--red); color: var(--red); }
    .modal-box.lockdown h2 { color: var(--red); }
    
    @keyframes blink { 50% { opacity: 0; } }
</style>
</head>
<body>
    <div class="scanlines"></div><div class="vignette"></div>

    <div id="terminal-box">
        <header>
            <div class="status">
                <div id="status-light" class="indicator ready"></div>
                <span id="status-text">מנותק</span>
            </div>
            <div>REDIANCE</div>
        </header>

        <div id="chat-container">
            <div style="text-align:center; color:#333; margin-top:50px;">מאתחל סנכרון...</div>
        </div>

        <div id="input-area">
            <button id="btn-main" onclick="handleAction()">התחבר</button>
            <input type="text" id="msg-input" placeholder="נדרש חיבור..." disabled>
        </div>

        <div id="login-modal" class="overlay">
            <div class="modal-box">
                <h2>בדיקת זהות</h2>
                <p style="font-size:0.9rem; margin-bottom:15px; color:#888;">הזן מפתח הצפנה</p>
                <input type="password" id="password-input" style="width:100%; text-align:center; letter-spacing:4px; border:1px solid #333; padding:10px; margin-bottom:15px; direction:ltr; color:var(--accent);">
                <button onclick="attemptLogin()" style="width:100%; padding:12px; background:var(--accent); border:none; font-weight:bold; cursor:pointer;">אימות</button>
                <button onclick="closeLogin()" style="width:100%; margin-top:10px; background:transparent; color:#666; border:none; cursor:pointer; font-size:0.8rem;">ביטול</button>
            </div>
        </div>

        <div id="lockdown-modal" class="overlay">
            <div class="modal-box lockdown">
                <h2>התנגשות אותות</h2>
                <p style="font-size:0.9rem; margin-bottom:20px;">זוהו מספר ניסיונות חיבור במקביל.</p>
                <p style="font-size:1.1rem; font-weight:bold; border-top:1px dashed #333; padding-top:15px;">המערכת ננעלה ל-30 שניות.</p>
                <div id="lock-timer" style="font-size:2rem; margin-top:15px;">30</div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyDHY2cf4SG3Y1_kL41DiZOgI6bmuTj0qWw", authDomain: "nehoranterminal.firebaseapp.com", projectId: "nehoranterminal", storageBucket: "nehoranterminal.firebasestorage.app", messagingSenderId: "264117742974", appId: "1:264117742974:web:b2ec0462046477ccbd972f" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let sessionID = localStorage.getItem('uplink_device_id');
    if (!sessionID) {
        sessionID = Math.random().toString(36).substr(2, 9);
        localStorage.setItem('uplink_device_id', sessionID);
    }
    
    let currentUser = null; 
    let isActiveSession = false;
    let heartbeatInterval;
    let watcherUnsub = null;

    const btnMain = document.getElementById('btn-main');
    const inputField = document.getElementById('msg-input');
    const statusText = document.getElementById('status-text');
    const statusLight = document.getElementById('status-light');

    (function checkStoredSession() {
        const storedUid = sessionStorage.getItem('uplink_uid');
        const storedSid = sessionStorage.getItem('uplink_sid');
        
        if (storedUid && storedSid) {
            db.collection('chat_users').doc(storedUid).get().then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.active_session === storedSid) {
                        currentUser = { id: doc.id, ...data };
                        takeOverSession(); 
                    } else {
                        sessionStorage.clear();
                    }
                }
            });
        }
    })();

    window.addEventListener('beforeunload', () => {
        if (currentUser && isActiveSession) {
            db.collection('chat_users').doc(currentUser.id).update({ active_session: null });
        }
    });

    db.collection('chat_messages').orderBy('timestamp', 'asc').onSnapshot(snap => {
        const container = document.getElementById('chat-container');
        container.innerHTML = ""; 
        let lastSender = "";

        if (snap.empty) {
            container.innerHTML = "<div style='text-align:center; color:#333; margin-top:50px;'>אין היסטוריה.</div>";
        } else {
            snap.docs.forEach((doc, index) => {
                const d = doc.data();
                lastSender = d.sender;
                renderMessage(container, d, index);
            });
        }
        
        container.scrollTop = container.scrollHeight;
        
        if (isActiveSession && currentUser) {
            if (lastSender === currentUser.username) {
                setInputState(false, "הודעה נשלחה. ממתין לתגובה...");
            } else {
                setInputState(true, "הקלד הודעה...");
            }
        }
    });

    function renderMessage(container, d, index) {
        const positionClass = (index % 2 === 0) ? 'pos-left' : 'pos-right';
        const color = d.color || "#ffb000";
        const div = document.createElement('div');
        div.className = `msg ${positionClass}`;
        div.innerHTML = `
            <div class="msg-sender" style="color:${color}">${d.sender}</div>
            <div class="msg-bubble" style="border-color:${color}; color:${color}; box-shadow: 0 0 5px ${color}33;">${d.text}</div>
        `;
        container.appendChild(div);
    }

    function handleAction() {
        if (!isActiveSession) {
            document.getElementById('login-modal').style.display = 'flex';
            setTimeout(() => document.getElementById('password-input').focus(), 100);
        } else {
            sendMessage();
        }
    }

    function closeLogin() { document.getElementById('login-modal').style.display = 'none'; }
    document.getElementById('password-input').addEventListener("keydown", (e) => { if(e.key==="Enter") attemptLogin(); });
    document.getElementById('msg-input').addEventListener("keydown", (e) => { if(e.key==="Enter") sendMessage(); });

    function attemptLogin() {
        const pass = document.getElementById('password-input').value;
        if(!pass) return;

        db.collection('chat_users').doc(pass).get().then(doc => {
            if(!doc.exists) {
                alert("קוד שגוי");
                document.getElementById('password-input').value = "";
            } else {
                const userData = doc.data();
                const userId = doc.id; 

                if (userData.lockdown_until && userData.lockdown_until.toMillis() > Date.now()) {
                    triggerLockdownUI(userData.lockdown_until.toMillis());
                    return;
                }

                const isMe = (userData.active_session === sessionID);
                const isTaken = !isMe && userData.active_session && (Date.now() - userData.last_active.toMillis() < 60000);
                
                if (isTaken) {
                    triggerGlobalLockdown(userId);
                } else {
                    currentUser = { id: userId, ...userData };
                    takeOverSession();
                }
            }
        });
    }

    function triggerGlobalLockdown(uid) {
        const lockTime = new Date(Date.now() + 30000);
        db.collection('chat_users').doc(uid).update({
            lockdown_until: firebase.firestore.Timestamp.fromDate(lockTime),
            active_session: null
        }).then(() => {
            triggerLockdownUI(lockTime.getTime());
        });
    }

    function triggerLockdownUI(endTime) {
        document.getElementById('login-modal').style.display = 'none';
        document.getElementById('lockdown-modal').style.display = 'flex';
        sessionStorage.clear();
        
        const interval = setInterval(() => {
            const left = Math.ceil((endTime - Date.now()) / 1000);
            if (left <= 0) {
                clearInterval(interval);
                document.getElementById('lockdown-modal').style.display = 'none';
                resetToOffline();
            } else {
                document.getElementById('lock-timer').innerText = left;
            }
        }, 1000);
    }

    function takeOverSession() {
        sessionStorage.setItem('uplink_uid', currentUser.id);
        sessionStorage.setItem('uplink_sid', sessionID);

        db.collection('chat_users').doc(currentUser.id).update({
            active_session: sessionID,
            last_active: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            startSessionWatcher();
            document.getElementById('login-modal').style.display = 'none';
            statusLight.className = "indicator online";
            statusText.innerText = currentUser.username.toUpperCase();
            btnMain.innerText = "שלח";
            isActiveSession = true;
            
            db.collection('chat_messages').orderBy('timestamp', 'desc').limit(1).get().then(snap => {
                if(snap.empty || snap.docs[0].data().sender !== currentUser.username) {
                    setInputState(true, "הקלד הודעה...");
                } else {
                    setInputState(false, "הודעה נשלחה. ממתין לתגובה...");
                }
            });
        });
    }

    function startSessionWatcher() {
        if(watcherUnsub) watcherUnsub(); 
        watcherUnsub = db.collection('chat_users').doc(currentUser.id).onSnapshot(doc => {
            if(!doc.exists) return;
            const data = doc.data();
            
            if (data.lockdown_until && data.lockdown_until.toMillis() > Date.now()) {
                isActiveSession = false;
                triggerLockdownUI(data.lockdown_until.toMillis());
                return;
            }

            if (data.active_session === sessionID) {
                statusLight.className = "indicator online";
                statusText.innerText = currentUser.username.toUpperCase();
            } else {
                resetToOffline();
            }
        });

        heartbeatInterval = setInterval(() => {
            if(isActiveSession) {
                db.collection('chat_users').doc(currentUser.id).get().then(doc => {
                    const d = doc.data();
                    if(d.lockdown_until && d.lockdown_until.toMillis() > Date.now()) {
                         isActiveSession = false;
                         triggerLockdownUI(d.lockdown_until.toMillis());
                    } else {
                        db.collection('chat_users').doc(currentUser.id).update({
                            last_active: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            } else {
                clearInterval(heartbeatInterval);
            }
        }, 30000); 
    }

    function resetToOffline() {
        isActiveSession = false;
        sessionStorage.clear();
        setInputState(false, "נדרש חיבור...");
        statusText.innerText = "מנותק";
        statusLight.className = "indicator ready"; 
        btnMain.innerText = "התחבר";
        btnMain.disabled = false;
    }

    function setInputState(enabled, placeholder) {
        inputField.disabled = !enabled;
        inputField.placeholder = placeholder;
        btnMain.disabled = !enabled;
        if(enabled) setTimeout(()=>inputField.focus(), 100);
    }

    function sendMessage() {
        if(!isActiveSession) return;
        const txt = inputField.value;
        if(!txt.trim()) return;
        inputField.value = "";
        
        db.collection('chat_messages').add({
            sender: currentUser.username,
            auth_key: currentUser.id,
            color: currentUser.color || "#ffb000",
            text: txt,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    }
</script>
</body>
</html>
